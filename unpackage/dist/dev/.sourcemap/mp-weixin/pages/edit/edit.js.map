{"version":3,"file":"edit.js","sources":["pages/edit/edit.vue","../../../H-builderx/HBuilderX/plugins/uniapp-cli-vite/uniPage:/cGFnZXMvZWRpdC9lZGl0LnZ1ZQ"],"sourcesContent":["<template>\r\n  <view class=\"edit-container\">\r\n    <view class=\"avatar-upload\">\r\n      <image class=\"avatar\" :src=\"userInfo.avatar\" mode=\"aspectFill\" @tap=\"previewAvatar(userInfo.avatar)\" />\r\n      <button class=\"upload-btn\" @tap=\"chooseAvatar\">更换头像</button>\r\n    </view>\r\n    \r\n    <input v-model=\"userInfo.username\" placeholder=\"用户名\" class=\"input-field\" />\r\n    <input v-model=\"userInfo.description\" placeholder=\"个人简介\" class=\"input-field\" />\r\n    <input v-model=\"userInfo.oldPassword\" type=\"password\" placeholder=\"原密码\" class=\"input-field\" />\r\n    <input v-model=\"userInfo.password\" type=\"password\" placeholder=\"新密码\" class=\"input-field\" />\r\n    <input v-model=\"userInfo.confirmPassword\" type=\"password\" placeholder=\"确认密码\" class=\"input-field\" />\r\n    \r\n    <button class=\"save-btn\" @tap=\"saveProfile\">保存修改</button>\r\n  </view>\r\n</template>\r\n\r\n<script>\r\nimport PubSub from 'pubsub-js';\r\nexport default {\r\n  data() {\r\n    return {\r\n      userInfo: {\r\n        account_id: '',\r\n        username: '',\r\n        description: '',\r\n        avatar: '/static/info/头像.png',\r\n        oldPassword: '',\r\n        password: '',\r\n        confirmPassword: ''\r\n      },\r\n      avatar_change: false, // 是否更换头像\r\n      token: '', // 用于订阅\r\n    }\r\n  },\r\n  methods: {\r\n    chooseAvatar() {\r\n      uni.chooseImage({\r\n        count: 1,\r\n        success: (res) => {\r\n          this.userInfo.avatar = res.tempFilePaths[0]\r\n          this.avatar_change = true;\r\n        }\r\n      })\r\n    },\r\n    async saveProfile() \r\n    {\r\n      if(this.userInfo.password){\r\n          if (!this.userInfo.oldPassword) \r\n          {\r\n              uni.showToast({ title: '请输入原密码', icon: 'none' })\r\n              return\r\n          }\r\n          \r\n          if (this.userInfo.password !== this.userInfo.confirmPassword) \r\n          {\r\n              uni.showToast({ title: '两次密码不一致', icon: 'none' })\r\n              return\r\n          }\r\n      }\r\n      try {\r\n        if(this.avatar_change){\r\n              const ext = this.userInfo.avatar.split('.').pop().toLowerCase();\r\n              const cloudPath = `User/${this.userInfo.account_id}-${this.userInfo.username}-${new Date().toISOString()}.${ext}`;\r\n              try{\r\n                const uploadRes = await uniCloud.uploadFile({\r\n                  filePath: this.userInfo.avatar,\r\n                  cloudPath,\r\n                  fileType: ext,\r\n                  cloudPathAsRealPath: true,\r\n                  onUploadProgress: (progress) => {\r\n                  // 显示上传进度\r\n                      var percentage = Math.round(progress.loaded * 100)/progress.total;\r\n                      uni.showLoading({ title: `上传中...${percentage}%` });\r\n                  }\r\n                });\r\n                this.userInfo.avatar = uploadRes.fileID;\r\n              }catch(err){\r\n                uni.showToast({ title: '图片上传失败', icon: 'none' });\r\n                return\r\n              }\r\n        }\r\n        const res = await uniCloud.callFunction({\r\n        name: 'update_userInfo',\r\n        data: {\r\n            old_avatar: this.old_avatar,\r\n            userInfo:{\r\n              ...this.userInfo\r\n            }\r\n        }\r\n        })\r\n        if (res.result.code === 0) {\r\n          const app = getApp();\r\n          app.userInfo = res.result.data;\r\n          uni.showToast({ title: '保存成功', icon: 'success' })\r\n          uni.navigateBack()\r\n        } else {\r\n        uni.showToast({ title: res.result.msg, icon: 'none' })\r\n        }\r\n      }catch (e) {\r\n          uni.showToast({ title: '保存失败', icon: 'none' })\r\n      }\r\n    },\r\n    previewAvatar(url){\r\n      uni.previewImage({\r\n        urls: [url],\r\n        current: url\r\n      })\r\n    }\r\n  },\r\n  onLoad(){\r\n    const app = getApp();\r\n    this.userInfo = app.userInfo;\r\n    \r\n  }\r\n}\r\n</script>\r\n\r\n<style>\r\n@import url('/pages/edit/edit.css');\r\n</style>","import MiniProgramPage from 'D:/CODE/vue/canteen_program/pages/edit/edit.vue'\nwx.createPage(MiniProgramPage)"],"names":["uni","uniCloud"],"mappings":";;AAmBA,MAAK,YAAU;AAAA,EACb,OAAO;AACL,WAAO;AAAA,MACL,UAAU;AAAA,QACR,YAAY;AAAA,QACZ,UAAU;AAAA,QACV,aAAa;AAAA,QACb,QAAQ;AAAA,QACR,aAAa;AAAA,QACb,UAAU;AAAA,QACV,iBAAiB;AAAA,MAClB;AAAA,MACD,eAAe;AAAA;AAAA,MACf,OAAO;AAAA;AAAA,IACT;AAAA,EACD;AAAA,EACD,SAAS;AAAA,IACP,eAAe;AACbA,oBAAAA,MAAI,YAAY;AAAA,QACd,OAAO;AAAA,QACP,SAAS,CAAC,QAAQ;AAChB,eAAK,SAAS,SAAS,IAAI,cAAc,CAAC;AAC1C,eAAK,gBAAgB;AAAA,QACvB;AAAA,OACD;AAAA,IACF;AAAA,IACD,MAAM,cACN;AACE,UAAG,KAAK,SAAS,UAAS;AACtB,YAAI,CAAC,KAAK,SAAS,aACnB;AACIA,wBAAG,MAAC,UAAU,EAAE,OAAO,UAAU,MAAM,QAAQ;AAC/C;AAAA,QACJ;AAEA,YAAI,KAAK,SAAS,aAAa,KAAK,SAAS,iBAC7C;AACIA,wBAAG,MAAC,UAAU,EAAE,OAAO,WAAW,MAAM,QAAQ;AAChD;AAAA,QACJ;AAAA,MACJ;AACA,UAAI;AACF,YAAG,KAAK,eAAc;AAChB,gBAAM,MAAM,KAAK,SAAS,OAAO,MAAM,GAAG,EAAE,MAAM;AAClD,gBAAM,YAAY,QAAQ,KAAK,SAAS,UAAU,IAAI,KAAK,SAAS,QAAQ,KAAI,oBAAI,KAAM,GAAC,YAAW,CAAE,IAAI,GAAG;AAC/G,cAAG;AACD,kBAAM,YAAY,MAAMC,cAAQ,GAAC,WAAW;AAAA,cAC1C,UAAU,KAAK,SAAS;AAAA,cACxB;AAAA,cACA,UAAU;AAAA,cACV,qBAAqB;AAAA,cACrB,kBAAkB,CAAC,aAAa;AAE5B,oBAAI,aAAa,KAAK,MAAM,SAAS,SAAS,GAAG,IAAE,SAAS;AAC5DD,oCAAI,YAAY,EAAE,OAAO,SAAS,UAAU,IAAI,CAAC;AAAA,cACrD;AAAA,YACF,CAAC;AACD,iBAAK,SAAS,SAAS,UAAU;AAAA,UAClC,SAAM,KAAI;AACTA,0BAAG,MAAC,UAAU,EAAE,OAAO,UAAU,MAAM,OAAK,CAAG;AAC/C;AAAA,UACF;AAAA,QACN;AACA,cAAM,MAAM,MAAMC,cAAQ,GAAC,aAAa;AAAA,UACxC,MAAM;AAAA,UACN,MAAM;AAAA,YACF,YAAY,KAAK;AAAA,YACjB,UAAS;AAAA,cACP,GAAG,KAAK;AAAA,YACV;AAAA,UACJ;AAAA,SACC;AACD,YAAI,IAAI,OAAO,SAAS,GAAG;AACzB,gBAAM,MAAM;AACZ,cAAI,WAAW,IAAI,OAAO;AAC1BD,wBAAG,MAAC,UAAU,EAAE,OAAO,QAAQ,MAAM,WAAW;AAChDA,wBAAAA,MAAI,aAAa;AAAA,eACZ;AACPA,8BAAI,UAAU,EAAE,OAAO,IAAI,OAAO,KAAK,MAAM,QAAQ;AAAA,QACrD;AAAA,MACD,SAAO,GAAG;AACPA,sBAAG,MAAC,UAAU,EAAE,OAAO,QAAQ,MAAM,QAAQ;AAAA,MACjD;AAAA,IACD;AAAA,IACD,cAAc,KAAI;AAChBA,oBAAAA,MAAI,aAAa;AAAA,QACf,MAAM,CAAC,GAAG;AAAA,QACV,SAAS;AAAA,OACV;AAAA,IACH;AAAA,EACD;AAAA,EACD,SAAQ;AACN,UAAM,MAAM;AACZ,SAAK,WAAW,IAAI;AAAA,EAEtB;AACF;;;;;;;;;;;;;;;;;;;;AClHA,GAAG,WAAW,eAAe;"}