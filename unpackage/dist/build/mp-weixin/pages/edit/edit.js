"use strict";const e=require("../../common/vendor.js"),o={data:()=>({userInfo:{account_id:"",username:"",description:"",avatar:"/static/info/头像.png",oldPassword:"",password:"",confirmPassword:""},avatar_change:!1,token:""}),methods:{chooseAvatar(){e.index.chooseImage({count:1,success:e=>{this.userInfo.avatar=e.tempFilePaths[0],this.avatar_change=!0}})},async saveProfile(){if(this.userInfo.password){if(!this.userInfo.oldPassword)return void e.index.showToast({title:"请输入原密码",icon:"none"});if(this.userInfo.password!==this.userInfo.confirmPassword)return void e.index.showToast({title:"两次密码不一致",icon:"none"})}try{if(this.avatar_change){const s=this.userInfo.avatar.split(".").pop().toLowerCase(),a=`User/${this.userInfo.account_id}-${this.userInfo.username}-${(new Date).toISOString()}.${s}`;try{const o=await e.tr.uploadFile({filePath:this.userInfo.avatar,cloudPath:a,fileType:s,cloudPathAsRealPath:!0,onUploadProgress:o=>{var s=Math.round(100*o.loaded)/o.total;e.index.showLoading({title:`上传中...${s}%`})}});this.userInfo.avatar=o.fileID}catch(o){return void e.index.showToast({title:"图片上传失败",icon:"none"})}}const s=await e.tr.callFunction({name:"update_userInfo",data:{old_avatar:this.old_avatar,userInfo:{...this.userInfo}}});if(0===s.result.code){getApp().userInfo=s.result.data,e.index.showToast({title:"保存成功",icon:"success"}),e.index.navigateBack()}else e.index.showToast({title:s.result.msg,icon:"none"})}catch(s){e.index.showToast({title:"保存失败",icon:"none"})}},previewAvatar(o){e.index.previewImage({urls:[o],current:o})}},onLoad(){const e=getApp();this.userInfo=e.userInfo}};const s=e._export_sfc(o,[["render",function(o,s,a,t,r,n){return{a:r.userInfo.avatar,b:e.o((e=>n.previewAvatar(r.userInfo.avatar))),c:e.o(((...e)=>n.chooseAvatar&&n.chooseAvatar(...e))),d:r.userInfo.username,e:e.o((e=>r.userInfo.username=e.detail.value)),f:r.userInfo.description,g:e.o((e=>r.userInfo.description=e.detail.value)),h:r.userInfo.oldPassword,i:e.o((e=>r.userInfo.oldPassword=e.detail.value)),j:r.userInfo.password,k:e.o((e=>r.userInfo.password=e.detail.value)),l:r.userInfo.confirmPassword,m:e.o((e=>r.userInfo.confirmPassword=e.detail.value)),n:e.o(((...e)=>n.saveProfile&&n.saveProfile(...e)))}}]]);wx.createPage(s);
