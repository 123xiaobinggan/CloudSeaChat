"use strict";const t=require("../../common/vendor.js"),e=require("../../common/assets.js"),s={data:()=>({post_id:"",user:{account_id:"",username:"",avatar:"/static/info/未登录.png",admin:!1},post:{},newComment:"",newReply:"",newReplyReply:"",replyPlaceholder:"发表评论...",last_showInput:null,isLoading:!0,no_post:!1,token:""}),onLoad(e){this.post_id=e.post_id,this.user.account_id=e.account_id,this.user.username=e.username||"未登录",this.user.avatar=e.avatar||"/static/info/未登录.png",this.user.admin=e.admin,t.index.showLoading({title:"加载中...",mask:!0}),this.fetchPost(this.post_id)},onUnload(){this.no_post&&t.index.$emit("return_from_source_post",this.post_id),this.token&&(t.PubSub.unsubscribe(this.token),this.token="")},methods:{async fetchPost(e){try{const s=await t.tr.callFunction({name:"get_target_post",data:{post_id:e,account_id:this.user.account_id}});200===s.result.code?(this.post=s.result.data,this.post.showComments=!0,console.log("comments",this.post.comments),t.index.showToast({title:"加载成功",icon:"success",duration:1e3})):this.no_post=!0}catch(s){console.error("获取帖子失败",s)}finally{t.index.hideLoading(),this.isLoading=!1}},formatDate(t){const e=t=>t.toString().padStart(2,"0");return`${(t=new Date(t)).getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())} ${e(t.getHours())}:${e(t.getMinutes())}`},previewMedia(e,s){t.index.previewMedia({sources:e.map((t=>({url:t.url,type:t.type}))),current:s})},async like(e,s,o,i,n){if(this.user.account_id){e.liked=!e.liked,e.like_count+=e.liked?1:-1;try{const a=await t.tr.callFunction({name:"user-liked",data:{target_id:e._id,post:s,comment:o,reply:i,account_id:this.user.account_id,type:n}});"请登录"===a.result.msg?t.index.showToast({title:"请登录",icon:"none"}):"success"!=a.result.msg?(e.liked=!e.liked,e.like_count-=e.liked?-1:1,t.index.showToast({title:a.result.message||"操作失败",icon:"none"})):a.result.first&&t.PubSub.publish("update_activity",5)}catch(a){console.error("点赞失败:",a),t.index.showToast({title:"网络错误",icon:"none"})}}else t.index.showToast({title:"请登录",icon:"none"})},confirmDeletePost(e){t.index.showModal({title:"确认删除",content:"确定要删除这条帖子吗？",success:t=>{t.confirm&&this.deletePost(e)}})},async deletePost(e){try{200===(await t.tr.callFunction({name:"delete_post",data:{post_id:e._id}})).result.code?(t.index.showToast({title:"删除成功",icon:"success"}),this.post={},this.no_post=!0):t.index.showToast({title:"删除失败",icon:"none"})}catch(s){console.error("删除失败:",s),t.index.showToast({title:"网络错误",icon:"none"})}},async submitComment(e,s,o,i,n){if(!this.newComment.trim()&&0==i||!this.newReply.trim()&&1==i||!this.newReplyReply.trim()&&2==i)t.index.showToast({title:"评论不能为空",icon:"none"});else if(this.user.account_id)try{const a=await t.tr.callFunction({name:"submit_comment",data:{user:this.user,post:e,comment:s,reply:o,type:i,content:n}});"success"==a.result.msg&&(0==i?(e.comment_count+=1,e.comments.unshift(a.result.data),this.newComment=""):(s.replies.unshift(a.result.data),o?(this.newReplyReply="",o.showReplyInput=!1):(this.newReply="",s.showReplyInput=!1)),t.index.showToast({title:"评论成功",icon:"success"}))}catch(a){t.index.showToast({title:"评论失败",icon:"none"})}else t.index.showToast({title:"请登录",icon:"none"})},handleLongPressComment_Reply(e,s,o,i,n){n.account_id&&n.account_id!==this.user.account_id&&!this.user.admin||t.index.showActionSheet({itemList:["删除"],success:a=>{0===a.tapIndex&&t.index.showModal({title:"确认删除",content:"确定要删除这条评论吗？",success:t=>{t.confirm&&this.deleteComment_Reply(e,s,o,i,n)}})}})},async deleteComment_Reply(e,s,o,i,n){let a=!0;a&&t.index.showToast({title:"删除中...",icon:"loading"});try{const o=await t.tr.callFunction({name:"delete_comment_reply",data:{parent:i,item:n}});a=!1,200===o.result.code&&(t.index.showToast({title:"删除成功",icon:"success"}),"post_id"in n?(this.posts[e].comments.splice(s,1),this.posts[e].comment_count-=1):(console.log("replies",o.result.data.replies),this.$set(this.posts[e].comments[s],"replies",o.result.data.replies)))}catch(l){console.error("删除失败:",l),t.index.showToast({title:"网络错误",icon:"none"})}},toggleReplyInput(t){this.$set(t,"showReplyInput",!t.showReplyInput),this.last_showInput&&this.last_showInput!==t&&(this.last_showInput.showReplyInput=!1),this.last_showInput=t},to_post(e,s){let o={};e&&(o=1==e.post_type&&e.source_post?e.source_post:e),t.index.navigateTo({url:"/pages/post/post",success:()=>{t.PubSub.publish("to_post",{share_post:o,type:s,account_id:this.user.account_id,username:this.user.username,avatar:this.user.avatar})}})},to_personal_info(e){e.account_id!=this.user.account_id&&t.index.navigateTo({url:`/pages/personal_info/personal_info?account_id=${e.account_id}&visitor_account_id=${this.user.account_id}&visitor_admin=${this.user.admin}`})}}};const o=t._export_sfc(s,[["render",function(s,o,i,n,a,l){var p,c,d,r;return t.e({a:!a.isLoading},a.isLoading?{}:t.e({b:!a.no_post},a.no_post?{}:t.e({c:a.post.avatar,d:t.t(a.post.username),e:t.t(l.formatDate(a.post.create_time)),f:t.t(a.post.ip),g:a.post.account_id==a.user.account_id||a.user.admin},a.post.account_id==a.user.account_id||a.user.admin?{h:e._imports_2,i:t.o((()=>l.confirmDeletePost(a.post)))}:{},{j:t.t(a.post.content),k:(null==(p=a.post.media)?void 0:p.length)>1},(null==(c=a.post.media)?void 0:c.length)>1?t.e({l:Array.isArray(a.post.media)&&a.post.media.length},Array.isArray(a.post.media)&&a.post.media.length?{m:t.f(a.post.media,((e,s,o)=>t.e({a:"image"===e.type},"image"===e.type?{b:e.url}:"video"===e.type?{d:e.url}:{},{c:"video"===e.type,e:s,f:t.o((()=>l.previewMedia(a.post.media,s)),s)}))),n:t.n("media-count-"+a.post.media.length)}:{}):1===(null==(d=a.post.media)?void 0:d.length)?t.e({p:"image"===a.post.media[0].type},"image"===a.post.media[0].type?{q:a.post.media[0].url}:"video"===a.post.media[0].type?{s:a.post.media[0].url}:{},{r:"video"===a.post.media[0].type,t:t.o((()=>l.previewMedia(a.post.media,0)))}):{},{o:1===(null==(r=a.post.media)?void 0:r.length),v:a.post.liked?"/static/index/已赞.png":"/static/index/赞.png",w:a.post.liked?1:"",x:t.t(a.post.like_count),y:t.o((()=>l.like(a.post,a.post,null,null,0))),z:e._imports_3,A:t.t(a.post.comment_count||0),B:e._imports_4,C:t.t(a.post.forward_count||0),D:t.o((()=>l.to_post(a.post,1))),E:a.post.showComments},a.post.showComments?{F:t.f(a.post.comments,((e,o,i)=>{var n,p;return t.e({a:e.avatar,b:t.o((t=>l.to_personal_info(e)),e._id),c:t.t(e.username),d:t.t(l.formatDate(e.create_time)),e:t.t(e.ip),f:e.liked?"/static/index/已赞.png":"/static/index/赞.png",g:t.t(e.like_count),h:t.o((()=>l.like(e,a.post,e,null,1)),e._id),i:t.t(e.content),j:t.o((()=>l.toggleReplyInput(e)),e._id),k:e.showReplyInput},e.showReplyInput?{l:"回复"+e.username+"...",m:a.newReply,n:t.o((t=>a.newReply=t.detail.value),e._id),o:t.o((()=>l.submitComment(a.post,e,null,1,a.newReply)),e._id)}:{},{p:(null==(n=e.replies)?void 0:n.length)&&!e.showReply},(null==(p=e.replies)?void 0:p.length)&&!e.showReply?{q:t.t(e.replies.length),r:t.o((t=>e.showReply=!0),e._id)}:{},{s:e.showReply},e.showReply?{t:t.f(e.replies,((i,n,p)=>t.e({a:i.avatar,b:t.o((t=>l.to_personal_info(i)),i._id),c:t.t(i.username),d:t.t(l.formatDate(i.date)),e:t.t(i.ip),f:i.liked?"/static/index/已赞.png":"/static/index/赞.png",g:t.t(i.like_count),h:t.o((()=>l.like(i,a.post,e,i,2)),i._id),i:i.reply_username},i.reply_username?{j:t.t(i.reply_username)}:{},{k:t.t(i.content),l:t.o((()=>l.toggleReplyInput(i)),i._id),m:i.showReplyInput},i.showReplyInput?{n:"回复"+i.username+"...",o:a.newReplyReply,p:t.o((t=>a.newReplyReply=t.detail.value),i._id),q:t.o((()=>l.submitComment(a.post,e,i,2,a.newReplyReply)),i._id)}:{},{r:i._id,s:t.o((t=>l.handleLongPressComment_Reply(s.postIndex,o,n,e,i)),i._id)})))}:{},{v:e._id,w:t.o((t=>l.handleLongPressComment_Reply(s.postIndex,o,null,a.post,e)),e._id)})})),G:a.newComment,H:t.o((t=>a.newComment=t.detail.value)),I:t.o((()=>l.submitComment(a.post,null,null,0,a.newComment))),J:t.o((()=>{}))}:{})))}],["__scopeId","data-v-d751d821"]]);wx.createPage(o);
