"use strict";const t=require("../../common/vendor.js"),e=require("../../common/assets.js"),o={data:()=>({user:{account_id:null,username:"未登录",description:"这个人很懒，什么都没有留下",avatar:"/static/info/未登录.png",background:"",post_count:0,visitor_count:0,level:0,activity:0,coupon:0,points:0,balance:0,admin:!1},visitor:{account_id:null,admin:!1,ip:"未知"},activeTab:"posts",userPosts:[],userVisitors:[],loading:!1,loaded:!1,newComment:"",newReply:"",newReplyReply:"",replyPlaceholder:"发表评论...",last_showInput:null,showBackToTop:!1,rotating:!1,navBarTop:0,lastScrollTop:0,showBackToTop:!1,newBackground:"",token:""}),watch:{activeTab(t,e){"visitors"==t&&0==this.userVisitors.length&&(console.log("fetchUserVisitors"),this.fetchUserVisitors())}},async onLoad(t){this.user.account_id=t.account_id,this.visitor.account_id=t.visitor_account_id,this.visitor.admin=1==t.visitor_admin||"true"==t.visitor_admin,console.log("visitor",this.visitor),await this.fetchUserInfo(),this.user.account_id&&this.fetchUserPosts(),t.account_id!==t.visitor_account_id&&t.visitor_account_id&&this.updateVisitor(t.account_id,t.visitor_account_id)},onUnload(){this.token&&(PubSub.unsubscribe(this.token),this.token="")},onReachBottom(){"posts"!==this.activeTab||this.loading?"visitors"!==this.activeTab||this.loading||(this.loading=!0,this.loaded=!1,this.fetchUserVisitors().then((()=>{this.loading=!1,this.loaded=!0})),setTimeout((()=>{this.loaded=!1}),1e3)):(this.loading=!0,this.loaded=!1,this.fetchUserPosts().then((()=>{this.loading=!1,this.loaded=!0})),setTimeout((()=>{this.loaded=!1}),1e3))},onPageScroll(t){this.lastScrollTop>=t.scrollTop&&t.scrollTop>=220?this.showBackToTop=!0:this.showBackToTop=!1,this.lastScrollTop=t.scrollTop},methods:{async fetchUserInfo(){try{const e=await t.tr.callFunction({name:"get_target_userInfo",data:{account_id:this.user.account_id}});200===e.result.code&&(console.log("获取用户信息成功",e.result.data),this.user=e.result.data,console.log("user",this.user))}catch(e){console.error("获取用户信息失败",e)}},async fetchUserPosts(){try{const e=await t.tr.callFunction({name:"get_user_posts",data:{account_id:this.user.account_id,page_size:5,create_time:this.userPosts.length>0?this.userPosts[this.userPosts.length-1].create_time:null,visitor_account_id:this.visitor.account_id}});200===e.result.code&&(console.log("获取用户帖子成功",e.result.data),this.userPosts=this.userPosts.concat(e.result.data))}catch(e){console.error("获取用户帖子失败",e),t.index.showToast({title:"获取帖子失败",icon:"none"})}},async fetchUserVisitors(){try{const e=await t.tr.callFunction({name:"get_user_visitors",data:{account_id:this.user.account_id,day_count:7,create_date:this.userVisitors.length>0?this.userVisitors[this.userVisitors.length-1].date:null}});200===e.result.code&&(console.log("获取用户访客成功",e.result.data),this.userVisitors=this.userVisitors.concat(e.result.data))}catch(e){console.error("获取用户访客失败",e),t.index.showToast({title:"获取访客失败",icon:"none"})}},async fetchComments(e){try{const o=await t.tr.callFunction({name:"get_comments",data:{post_id:e._id}});if("success"==o.result.msg&&(e.comments=o.result.data,e.comment_count=e.comments.length,this.user.account_id)){const o=t.tr.database(),s=(await o.collection("user-liked").where({account_id:this.user.account_id,target_id:o.command.in(e.comments.map((t=>t._id))),liked:!0}).get()).result.data.map((t=>t.target_id));let i=[];for(const t of e.comments)t.liked=s.includes(t._id),i=i.concat(t.replies);if(i.length>0){const t=(await o.collection("user-liked").where({account_id:this.user.account_id,target_id:o.command.in(i.map((t=>t._id))),liked:!0}).get()).result.data.map((t=>t.target_id));e.comments.forEach((e=>{e.replies.forEach((e=>{e.liked=t.includes(e._id)}))}))}}}catch(o){console.error("获取评论失败:",o)}},async updateVisitor(e,o){await this.getUserLocation(),await this.resolve_ip();const s=await t.tr.callFunction({name:"update_visitor",data:{account_id:e,visitor_account_id:o,visitor_ip:this.visitor.ip}});this.user.visitor_count+=s.result.data,console.log("update_visitor",s)},async getUserLocation(){try{const e=await t.tr.callFunction({name:"get_ip",data:{}});200===e.result.code&&(this.visitor.ip=e.result.data)}catch(e){console.error("获取位置失败",e)}},async resolve_ip(){const e=`https://ipcity.market.alicloudapi.com/ip/city/query?${`ip=${encodeURIComponent(this.visitor.ip)}&coordsys=WGS84`}`;try{const o=await t.index.request({url:e,method:"GET",header:{Authorization:"APPCODE 1dc84a4fe7fc40238d1a17ad665c59d3"}});if(200===o.statusCode&&200==o.data.code){let t;o.data.data.result.city?t=o.data.data.result.city:o.data.data.result.prov?t=o.data.data.result.province:o.data.data.result.country?t=o.data.data.result.country:o.data.data.result.continuent&&(t=o.data.data.result.continent),(t.endsWith("市")||t.endsWith("省"))&&(t=t.slice(0,-1)),this.visitor.ip=t,console.log("获取到的IP地址",this.visitor.ip)}}catch(o){console.error("resolve_ip 请求失败:",o)}},previewMedia(e,o){t.index.previewMedia({sources:e.map((t=>({url:t.url,type:t.type}))),current:o})},previewAvatar(e){t.index.previewImage({current:e,urls:[e]})},confirmDeletePost(e){t.index.showModal({title:"确认删除",content:"确定要删除这条帖子吗？",success:t=>{t.confirm&&this.deletePost(e)}})},async deletePost(e){try{200===(await t.tr.callFunction({name:"delete_post",data:{post_id:e._id}})).result.code?(t.index.showToast({title:"删除成功",icon:"success"}),this.posts=this.posts.filter((t=>t._id!==e._id))):t.index.showToast({title:"删除失败",icon:"none"})}catch(o){console.error("删除失败:",o),t.index.showToast({title:"网络错误",icon:"none"})}},async like(e,o,s,i,a){if(this.visitor.account_id){e.liked=!e.liked,e.like_count+=e.liked?1:-1;try{const n=await t.tr.callFunction({name:"user-liked",data:{target_id:e._id,post:o,comment:s,reply:i,account_id:this.visitor.account_id,type:a}});"请登录"===n.result.msg?t.index.showToast({title:"请登录",icon:"none"}):"success"!=n.result.msg?(e.liked=!e.liked,e.like_count-=e.liked?-1:1,t.index.showToast({title:n.result.message||"操作失败",icon:"none"})):n.result.first&&PubSub.publish("update_activity",5)}catch(n){console.error("点赞失败:",n),t.index.showToast({title:"网络错误",icon:"none"})}}else t.index.showToast({title:"请登录",icon:"none"})},toggleComments(t){this.userPosts.forEach((e=>{e._id===t._id?e.showComments=!e.showComments:e.showComments=!1})),t.comments||this.fetchComments(t)},async submitComment(e,o,s,i,a){if(!this.newComment.trim()&&0==i||!this.newReply.trim()&&1==i||!this.newReplyReply.trim()&&2==i)return void t.index.showToast({title:"评论不能为空",icon:"none"});if(!this.visitor.account_id)return void t.index.showToast({title:"请登录",icon:"none"});let n=!0;n&&t.index.showToast({title:"提交中...",icon:"loading"});try{const c=await t.tr.callFunction({name:"submit_comment",data:{user:this.visitor,post:e,comment:o,reply:s,type:i,content:a}});"success"==c.result.msg&&(0==i?(e.comment_count+=1,e.comments.unshift(c.result.data),this.newComment=""):(o.replies.unshift(c.result.data),s?(this.newReplyReply="",s.showReplyInput=!1):(this.newReply="",o.showReplyInput=!1)),n=!1,t.index.showToast({title:"评论成功",icon:"success"}))}catch(c){t.index.showToast({title:"评论失败",icon:"none"})}},handleLongPressComment_Reply(e,o,s,i,a){a.account_id&&a.account_id!==this.visitor.account_id&&!this.visitor.admin||t.index.showActionSheet({itemList:["删除"],success:n=>{0===n.tapIndex&&t.index.showModal({title:"确认删除",content:"确定要删除这条评论吗？",success:t=>{t.confirm&&this.deleteComment_Reply(e,o,s,i,a)}})}})},async deleteComment_Reply(e,o,s,i,a){let n=!0;n&&t.index.showToast({title:"删除中...",icon:"loading"});try{const s=await t.tr.callFunction({name:"delete_comment_reply",data:{parent:i,item:a}});n=!1,200===s.result.code&&(t.index.showToast({title:"删除成功",icon:"success"}),"post_id"in a?(this.userPosts[e].comments.splice(o,1),this.userPosts[e].comment_count-=1):(console.log("replies",s.result.data.replies),this.$set(this.userPosts[e].comments[o],"replies",s.result.data.replies)))}catch(c){console.error("删除失败:",c),t.index.showToast({title:"网络错误",icon:"none"})}},formatDate(t){const e=t=>t.toString().padStart(2,"0");return`${(t=new Date(t)).getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())} ${e(t.getHours())}:${e(t.getMinutes())}`},toggleReplyInput(t){this.$set(t,"showReplyInput",!t.showReplyInput),this.last_showInput&&this.last_showInput!==t&&(this.last_showInput.showReplyInput=!1),this.last_showInput=t},scrollToTop(){this.rotating=!0,setTimeout((()=>{this.rotating=!1}),500),t.index.pageScrollTo({scrollTop:0,duration:300})},changeBackground(){this.user.account_id===this.visitor.account_id&&t.index.showActionSheet({itemList:["更换背景"],success:e=>{0===e.tapIndex&&t.index.chooseImage({count:1,sizeType:["compressed"],sourceType:["album","camera"],success:t=>{this.newBackground=t.tempFilePaths[0],this.update_background()}})}})},async update_background(){const e=this.user.background.split(".").pop().toLowerCase(),o=`Personal_background/${this.user.account_id}-${this.user.username}-${(new Date).toISOString()}.${e}`;try{const s=await t.tr.uploadFile({filePath:this.newBackground,cloudPath:o,fileType:e,cloudPathAsRealPath:!0,onUploadProgress:e=>{var o=Math.round(100*e.loaded)/e.total;t.index.showLoading({title:`上传中...${o}%`})}});console.log("uploadRes",s),this.newBackground=s.fileID;const i=await t.tr.callFunction({name:"update_background",data:{oldBackground:this.user.background,newBackground:this.newBackground,account_id:this.user.account_id}});console.log("update_background",i),200===i.result.code?(this.user.background=this.newBackground,t.index.showToast({title:"更换成功",icon:"success"})):(this.user.background="https://mp-ad47c7bd-10fe-4cc5-9ad0-a7ff552214bc.cdn.bspapp.com/Personal_background/sunset.jpg",t.index.showToast({title:"更换失败",icon:"none"}))}catch(s){t.index.showToast({title:"图片上传失败",icon:"none"}),console.log("图片上传失败",s)}},to_source_post(e){t.index.navigateTo({url:`/pages/source_post/source_post?post_id=${e.source_post.post_id}&account_id=${this.user.account_id}&admin=${this.user.admin}&username=${this.user.username}&avatar=${this.user.avatar}`})},to_personal_info(e){t.index.navigateTo({url:`/pages/personal_info/personal_info?account_id=${e.account_id}&visitor_account_id=${this.user.account_id}&visitor_admin=${this.user.admin}`})}}};const s=t._export_sfc(o,[["render",function(o,s,i,a,n,c){return t.e({a:t.o(((...t)=>c.changeBackground&&c.changeBackground(...t))),b:n.user.background,c:n.user.avatar,d:t.o((t=>c.previewAvatar(n.user.avatar))),e:t.t(n.user.username),f:t.t(n.user.account_id),g:t.t(n.user.description),h:e._imports_0$3,i:t.t(n.user.post_count),j:"posts"===n.activeTab?1:"",k:t.o((t=>n.activeTab="posts")),l:e._imports_1$1,m:t.t(n.user.visitor_count),n:"visitors"===n.activeTab?1:"",o:t.o((t=>n.activeTab="visitors")),p:"posts"==n.activeTab},"posts"==n.activeTab?{q:t.f(n.userPosts,((e,s,i)=>t.e({a:t.t(c.formatDate(e.create_time)),b:t.t(e.ip),c:t.o((()=>c.confirmDeletePost(e)),s),d:0==e.post_type},0==e.post_type?t.e({e:t.t(e.content),f:e.media.length>1},e.media.length>1?t.e({g:Array.isArray(e.media)&&e.media.length},Array.isArray(e.media)&&e.media.length?{h:t.f(e.media,((o,s,i)=>t.e({a:"image"===o.type},"image"===o.type?{b:o.url}:"video"===o.type?{d:o.url}:{},{c:"video"===o.type,e:s,f:t.o((()=>c.previewMedia(e.media,s)),s)}))),i:t.n("media-count-"+e.media.length)}:{}):1==e.media.length?t.e({k:"image"===e.media[0].type},"image"===e.media[0].type?{l:e.media[0].url}:"video"===e.media[0].type?{n:e.media[0].url}:{},{m:"video"===e.media[0].type,o:t.o((()=>c.previewMedia(e.media,0)),s)}):{},{j:1==e.media.length}):t.e({p:t.t(e.content),q:e.source_post.avatar},e.source_post.avatar?{r:e.source_post.avatar}:{},{s:e.source_post.username},e.source_post.username?{t:t.t(e.source_post.username)}:{},{v:e.source_post.create_time},e.source_post.create_time?{w:t.t(c.formatDate(e.source_post.create_time)),x:t.t(e.source_post.ip)}:{},{y:e.source_post.content},e.source_post.content?{z:t.t(e.source_post.content)}:{},{A:e.source_post.media},e.source_post.media?t.e({B:e.source_post.media.length>1},e.source_post.media.length>1?t.e({C:Array.isArray(e.source_post.media)&&e.source_post.media.length},Array.isArray(e.source_post.media)&&e.source_post.media.length?{D:t.f(e.source_post.media,((o,s,i)=>t.e({a:"image"===o.type},"image"===o.type?{b:o.url}:"video"===o.type?{d:o.url}:{},{c:"video"===o.type,e:s,f:t.o((()=>c.previewMedia(e.source_post.media,s)),s)}))),E:t.n("media-count-"+e.source_post.media.length)}:{}):1==e.source_post.media.length?t.e({G:"image"===e.source_post.media[0].type},"image"===e.source_post.media[0].type?{H:e.source_post.media[0].url}:"video"===e.source_post.media[0].type?{J:e.source_post.media[0].url}:{},{I:"video"===e.source_post.media[0].type,K:t.o((()=>c.previewMedia(e.source_post.media,0)),s)}):{},{F:1==e.source_post.media.length}):{},{L:t.o((t=>c.to_source_post(e)),s)}),{M:t.t(e.device_model),N:e.liked?"/static/index/已赞.png":"/static/index/赞.png",O:e.liked?1:"",P:t.t(e.like_count),Q:t.o((()=>c.like(e,e,null,null,0)),s),R:t.t(e.comment_count||0),S:t.o((()=>c.toggleComments(e)),s),T:t.t(e.forward_count||0),U:t.o((()=>o.to_post(e,1)),s),V:e.showComments},e.showComments?{W:t.f(e.comments,((o,i,a)=>t.e({a:o.avatar,b:t.o((t=>c.to_personal_info(o)),i),c:t.t(o.username),d:t.t(c.formatDate(o.create_time)),e:t.t(o.ip),f:o.liked?"/static/index/已赞.png":"/static/index/赞.png",g:t.t(o.like_count),h:t.o((()=>c.like(o,e,o,null,1)),i),i:t.t(o.content),j:t.o((()=>c.toggleReplyInput(o)),i),k:o.showReplyInput},o.showReplyInput?{l:"回复"+o.username+"...",m:n.newReply,n:t.o((t=>n.newReply=t.detail.value),i),o:t.o((()=>c.submitComment(e,o,null,1,n.newReply)),i)}:{},{p:o.replies.length&&!o.showReply},o.replies.length&&!o.showReply?{q:t.t(o.replies.length),r:t.o((t=>o.showReply=!0),i)}:{},{s:o.showReply},o.showReply?{t:t.f(o.replies,((a,r,l)=>t.e({a:a.avatar,b:t.o((t=>c.to_personal_info(a)),a._id),c:t.t(a.username),d:t.t(c.formatDate(a.create_time)),e:t.t(a.ip),f:a.liked?"/static/index/已赞.png":"/static/index/赞.png",g:t.t(a.like_count),h:t.o((()=>c.like(a,e,o,a,2)),a._id),i:a.reply_username},a.reply_username?{j:t.t(a.reply_username)}:{},{k:t.t(a.content),l:t.o((()=>c.toggleReplyInput(a)),a._id),m:a.showReplyInput},a.showReplyInput?{n:"回复"+a.username+"...",o:n.newReplyReply,p:t.o((t=>n.newReplyReply=t.detail.value),a._id),q:t.o((()=>c.submitComment(e,o,a,2,n.newReplyReply)),a._id)}:{},{r:a._id,s:t.o((t=>c.handleLongPressComment_Reply(s,i,r,o,a)),a._id)})))}:{},{v:i,w:t.o((t=>c.handleLongPressComment_Reply(s,i,null,e,o)),i)}))),X:n.newComment,Y:t.o((t=>n.newComment=t.detail.value),s),Z:t.o((()=>c.submitComment(e,null,null,0,n.newComment)),s),aa:t.o((()=>{}),s)}:{},{ab:s}))),r:n.user.avatar,s:t.t(n.user.username),t:e._imports_2,v:n.visitor.account_id===n.user.account_id||n.visitor.admin,w:e._imports_3,x:e._imports_4}:"visitors"==n.activeTab?{z:t.f(n.userVisitors,((e,o,s)=>({a:t.t(e.date),b:t.f(e.visitors,((e,o,s)=>({a:e.avatar,b:t.t(e.username),c:t.t(c.formatDate(e.create_time)),d:t.t(e.ip),e:o}))),c:o})))}:{},{y:"visitors"==n.activeTab,A:n.loading&&!n.loaded},(n.loading&&n.loaded,{}),{B:n.loaded&&!n.loading},(n.loaded&&n.loading,{}),{C:0==n.userPosts.length&&"posts"==n.activeTab},0==n.userPosts.length&&"posts"==n.activeTab?t.e({D:n.user.account_id==n.visitor.account_id},(n.user.account_id,n.visitor.account_id,{})):(0==n.userVisitors.length&&n.activeTab,{}),{E:0==n.userVisitors.length&&"visitors"==n.activeTab,F:e._imports_5,G:n.showBackToTop?1:"",H:n.showBackToTop?1:"",I:n.showBackToTop?"":1,J:t.o(((...t)=>c.scrollToTop&&c.scrollToTop(...t)))})}]]);o.__runtimeHooks=1,wx.createPage(s);
