"use strict";const t=require("../../common/vendor.js"),e={data:()=>({user:{account_id:"",ip:"未知"},tabs:[{icon:"/static/index/赞.png",type:"like",count:0},{icon:"/static/index/评论.png",type:"comment",count:0},{icon:"/static/index/转发.png",type:"share",count:0}],activeTab:0,groupedMessagesByType:{like:[],comment:[],share:[]},token:"",loading:!1,loaded:!1,StartX:"",dragging:!1,translateX:0,windowWidth:375,newReply:"",lastShowInput:null}),computed:{currentMessages(){return this.groupedMessagesByType[this.tabs[this.activeTab].type]},contentStyle(){const t=this.dragging?"none":"transform 0.3s ease";return`width: ${100*this.tabs.length}%; display: flex; transform: translateX(${this.translateX}px); transition: ${t};`}},watch:{immediate:!0,"user.account_id"(){console.log("account_id change"),this.groupedMessagesByType.like=[],this.groupedMessagesByType.comment=[],this.groupedMessagesByType.share=[],this.fetchMessages("like"),this.fetchMessages("comment"),this.fetchMessages("share")},activeTab(){this.translateX=-this.windowWidth*this.activeTab},tabs:{deep:!0,handler(){this.tabs[0].count+this.tabs[1].count+this.tabs[2].count>0?t.index.showTabBarRedDot({index:1}):t.index.hideTabBarRedDot({index:1})}}},mounted(){t.index.getSystemInfo({success:t=>{this.windowWidth=t.windowWidth,this.translateX=-this.activeTab*t.windowWidth}})},onShow(){const t=getApp();t.userInfo&&(this.user.account_id=t.userInfo.account_id,console.log("messges收到用户信息",this.user))},onPullDownRefresh(){this.loading||(this.groupedMessagesByType[this.tabs[this.activeTab].type]=[],this.fetchMessages(this.tabs[this.activeTab].type).finally((()=>{t.index.stopPullDownRefresh()})))},onReachBottom(){console.log("OnreachBottom"),this.loading||(this.loading=!0,this.loaded=!1,this.fetchMessages(this.activeTab).finally((()=>{this.loading=!1,this.loaded=!0,setTimeout((()=>{this.loaded=!1}),2e3)})))},methods:{async switchTab(t){this.activeTab=t},async fetchMessages(e){if(this.user.account_id)try{const s=e,a=this.groupedMessagesByType[s]||[],o=a.length,n=await t.tr.callFunction({name:"get_messages",data:{account_id:this.user.account_id,type:s,create_date:o>0?a[o-1].create_date:null,day_count:7}});200===n.result.code?(console.log("收到消息",n.result.data),this.groupedMessagesByType[s]=a.concat(n.result.data),this.updateTabCounts()):t.index.showToast({title:"获取消息失败",icon:"none"})}catch(s){console.log(s)}else console.log("请登录")},formatDate(t){const e=t=>t.toString().padStart(2,"0");return`${(t=new Date(t)).getFullYear()}-${e(t.getMonth()+1)}-${e(t.getDate())} ${e(t.getHours())}:${e(t.getMinutes())}`},async markMessagesAsRead(e){console.log("click");let s=[];if(console.log("messages",e),e.forEach((t=>{(t.messages||[]).forEach((t=>{t.action_type==this.tabs[this.activeTab].type&&(t.read=!0,s.push(t))}))})),s)try{await t.tr.callFunction({name:"update_read",data:{messages:s}}),this.updateTabCounts()}catch(a){console.log(a)}else console.log("no_need_update")},updateTabCounts(){this.tabs[0].count=0,this.tabs[1].count=0,this.tabs[2].count=0,Object.values(this.groupedMessagesByType).forEach((t=>{Array.isArray(t)&&t.forEach((t=>{(t.messages||[]).forEach((t=>{t.read||this.tabs[this.return_index(t.action_type)].count++}))}))}))},return_index:t=>"like"===t?0:"comment"===t?1:"share"===t?2:void 0,getMessageText:t=>"post"===t.target_type&&"like"===t.action_type?"点赞了你的帖子":"comment"===t.target_type&&"like"===t.action_type?"点赞了你的评论":"post"===t.target_type&&"comment"===t.action_type?"评论了你的帖子":"comment"===t.target_type&&"comment"===t.action_type?"回复了你的评论":"post"===t.target_type&&"share"===t.action_type?"转发了你的帖子":"",onTouchStart(t){this.startX=t.touches[0].clientX,this.dragging=!0},onTouchMove(t){if(!this.dragging)return;const e=t.touches[0].clientX-this.startX;this.translateX=-this.activeTab*this.windowWidth+e},onTouchEnd(t){const e=t.changedTouches[0].clientX-this.startX,s=this.windowWidth/4;e>s&&this.activeTab>0?this.activeTab--:e<-s&&this.activeTab<Object.keys(this.tabs).length-1&&this.activeTab++,this.translateX=-this.activeTab*this.windowWidth,this.dragging=!1},to_personal_info(e){const s=e.source_post?e.source_post.admin:e.source_comment.admin;console.log("admin",s),t.index.navigateTo({url:`/pages/personal_info/personal_info?account_id=${e.actor_account_id}&visitor_account_id=${this.user.account_id}&visitor_admin=${s}`})},to_source_post(e){t.index.navigateTo({url:`/pages/source_post/source_post?post_id=${e.source_post._id}&account_id=${this.user.account_id}&admin=${e.source_post.admin}&username=${e.source_post.username}&avatar=${e.source_post.avatar}`})},toggleReplyInput(t){this.lastShowInput&&this.lastShowInput!==t&&(this.lastShowInput.showInput=!1),t.showInput=!t.showInput,this.lastShowInput=t,console.log("msg",t.showInput)},async submitComment(e,s){if(!s.trim())return void t.index.showToast({title:"评论不能为空",icon:"none"});if(!this.user.account_id)return void t.index.showToast({title:"请登录",icon:"none"});let a=!0;a&&t.index.showToast({title:"评论中...",icon:"loading"}),await this.getUserLocation(),await this.resolve_ip();const o={_id:e.comment_id,account_id:e.actor_account_id,content:s},n={account_id:e.actor_account_id,username:e.actor_username,avatar:e.actor_avatar,content:s};try{"success"==(await t.tr.callFunction({name:"submit_comment",data:{user:this.user,post:null,comment:o,reply:n,type:1,content:s}})).result.msg&&(e.showInput=!1,this.newReply="",a=!1,t.index.showToast({title:"评论成功",icon:"success"}))}catch(i){t.index.showToast({title:"评论失败",icon:"none"})}},async getUserLocation(){try{const e=await t.tr.callFunction({name:"get_ip",data:{}});200===e.result.code&&(this.user.ip=e.result.data)}catch(e){console.error("获取位置失败",e)}},async resolve_ip(){const e=`https://ipcity.market.alicloudapi.com/ip/city/query?${`ip=${encodeURIComponent(this.user.ip)}&coordsys=WGS84`}`;try{const s=await t.index.request({url:e,method:"GET",header:{Authorization:"APPCODE 1dc84a4fe7fc40238d1a17ad665c59d3"}});if(200===s.statusCode&&200==s.data.code){let t;s.data.data.result.city?t=s.data.data.result.city:s.data.data.result.prov?t=s.data.data.result.province:s.data.data.result.country?t=s.data.data.result.country:s.data.data.result.continuent&&(t=s.data.data.result.continent),(t.endsWith("市")||t.endsWith("省"))&&(t=t.slice(0,-1)),this.user.ip=t,console.log("获取到的IP地址",this.user.ip)}}catch(s){console.error("resolve_ip 请求失败:",s)}}}};const s=t._export_sfc(e,[["render",function(e,s,a,o,n,i){return{a:t.f(n.tabs,((e,s,a)=>t.e({a:e.icon,b:e.count>0},e.count>0?{c:t.t(e.count)}:{},{d:s,e:n.activeTab===s?1:"",f:t.o((t=>i.switchTab(s)),s)}))),b:t.o((t=>i.markMessagesAsRead(n.groupedMessagesByType[n.tabs[n.activeTab].type]))),c:t.f(n.tabs,((e,s,a)=>t.e({a:0===n.groupedMessagesByType[e.type].length},(n.groupedMessagesByType[e.type].length,{}),{b:t.f(n.groupedMessagesByType[e.type],((e,s,a)=>({a:t.t(e.create_date),b:t.f(e.messages,((s,a,o)=>t.e({a:s.actor_avatar,b:t.o((t=>i.to_personal_info(s)),a),c:t.t(s.actor_username||"未知"),d:t.t(i.getMessageText(s)),e:t.t(i.formatDate(s.create_time)),f:t.t(s.ip),g:!s.read},(s.read,{}),{h:s.content&&"like"!==s.action_type},s.content&&"like"!==s.action_type?{i:t.t(s.content)}:{},{j:"post"===s.target_type},"post"===s.target_type?{k:s.source_post.avatar,l:t.t(s.source_post.username||"未知"),m:t.t(i.formatDate(s.source_post.create_time)),n:t.t(s.source_post.ip),o:t.t(s.source_post.content),p:t.o((t=>i.to_source_post(s)),a)}:{},{q:"comment"===s.target_type},"comment"===s.target_type?{r:t.t(s.source_comment.username||"未知"),s:t.t(s.source_comment.content)}:{},{t:"comment"==s.action_type},"comment"==s.action_type?{v:t.o((t=>i.toggleReplyInput(s)),a)}:{},{w:"comment"==s.action_type&&s.showInput},"comment"==s.action_type&&s.showInput?{x:"回复"+s.actor_username+"...",y:n.newReply,z:t.o((t=>n.newReply=t.detail.value),a),A:t.o((()=>i.submitComment(s,n.newReply)),a),B:t.o((()=>{}),a)}:{},{C:a,D:t.o((t=>i.markMessagesAsRead([{create_date:e.create_date,messages:[s]}])),a)}))),c:s})))},(n.loading&&n.loaded,{}),(n.loaded&&n.loading,{}),{c:s}))),d:n.loading&&!n.loaded,e:n.loaded&&!n.loading,f:t.s(i.contentStyle),g:t.o(((...t)=>i.onTouchStart&&i.onTouchStart(...t))),h:t.o(((...t)=>i.onTouchEnd&&i.onTouchEnd(...t))),i:t.o(((...t)=>i.onTouchMove&&i.onTouchMove(...t)))}}],["__scopeId","data-v-fcf0145e"]]);wx.createPage(s);
