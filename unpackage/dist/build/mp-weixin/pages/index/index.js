"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),s={data:()=>({searchQuery:"",posts:[],filteredPosts:[],newComment:"",newReply:"",newReplyReply:"",user:{account_id:"",username:"未登录",description:"这个人很懒，什么都没有留下",avatar:"/static/info/头像.png",admin:!1,ip:"未知"},replyPlaceholder:"发表评论...",last_showInput:null,loading:!1,loaded:!1,token:"",lastScrollTop:0,show_top_bar:!0,isAtTop:!0}),watch:{posts:{deep:!0,handler(){this.filteredPosts=this.posts,this.filterPosts()}},"user.account_id":{handler(){this.posts=[],this.fetchPosts(null,!1)}}},onShow(){const e=getApp();e.userInfo&&e.userInfo.account_id!==this.user.account_id&&(this.user=e.userInfo,console.log("onShow用户信息更新:",this.user))},async onLoad(){const t=e.index.getStorageSync("uid");t?await this.login_register("login",t,"","",!0):(this.posts=[],this.fetchPosts(null,!1)),this.token=e.PubSub.subscribe("return_index",((t,s)=>{this.posts.unshift(s),e.PubSub.publish("update_activity",20)})),e.index.$on("return_from_source_post",(e=>{this.posts=this.posts.filter((t=>t._id!==e))}))},onUnload(){this.token&&(e.PubSub.unsubscribe(this.token),this.token=null),e.index.$off("return_from_source_post")},onReachBottom(){if(this.loading)return;this.loading=!0,this.loaded=!1;let e=this.posts.length>0?this.posts[this.posts.length-1]:null;this.fetchPosts(e,!0).finally((()=>{this.loading=!1,this.loaded=!0,setTimeout((()=>{this.loaded=!1}),2e3)}))},onPullDownRefresh(){this.loading||(this.posts=[],this.fetchPosts(null,!1).finally((()=>{e.index.stopPullDownRefresh()})))},onPageScroll(e){const t=e.scrollTop;this.isAtTop=0===t,t<=this.lastScrollTop?this.show_top_bar=!0:this.show_top_bar=!1,this.lastScrollTop=t},methods:{async fetchPosts(t,s){try{const o=await e.tr.callFunction({name:"get_posts",data:{post_create_time:t?t.create_time:null,page_size:5,lt:s,account_id:this.user.account_id}});if(0===o.result.code){const{posts:e}=o.result.data;console.log("获取帖子成功:",e),this.posts=[...this.posts,...e]}else console.error("获取帖子失败:",o.result.msg)}catch(o){console.error("获取帖子时发生错误:",o)}},filterPosts(){this.filteredPosts=this.posts.filter((e=>{var t,s;const o=this.searchQuery.trim().toLowerCase(),i=e.content&&e.content.toLowerCase().includes(o)||e.username&&e.username.toLowerCase().includes(o),n=1===e.post_type&&((null==(t=e.source_post)?void 0:t.content)&&e.source_post.content.toLowerCase().includes(o)||(null==(s=e.source_post)?void 0:s.username)&&e.source_post.username.toLowerCase().includes(o));return i||n}))},previewMedia(t,s){e.index.previewMedia({sources:t.map((e=>({url:e.url,type:e.type}))),current:s})},to_post(t,s){let o={};t&&(o=1==t.post_type&&t.source_post?t.source_post:t),e.index.navigateTo({url:"/pages/post/post",success:()=>{e.PubSub.publish("to_post",{share_post:o,type:s,account_id:this.user.account_id,username:this.user.username,avatar:this.user.avatar})}})},confirmDeletePost(t){e.index.showModal({title:"确认删除",content:"确定要删除这条帖子吗？",success:e=>{e.confirm&&this.deletePost(t)}})},async deletePost(t){e.index.showToast({title:"删除中",icon:"loading"});try{200===(await e.tr.callFunction({name:"delete_post",data:{post_id:t._id,account_id:t.account_id}})).result.code?(e.index.hideToast(),e.index.showToast({title:"删除成功",icon:"success"}),this.posts=this.posts.filter((e=>e._id!==t._id))):e.index.showToast({title:"删除失败",icon:"none"})}catch(s){console.error("删除失败:",s),e.index.showToast({title:"网络错误",icon:"none"})}finally{e.index.hideToast()}},async like(t,s,o,i,n){if(this.user.account_id){t.liked=!t.liked,t.like_count+=t.liked?1:-1,await this.getUserLocation(),await this.resolve_ip();try{const a=await e.tr.callFunction({name:"user-liked",data:{target_id:t._id,post:s,comment:o,reply:i,account_id:this.user.account_id,type:n,ip:this.user.ip}});"请登录"===a.result.msg?e.index.showToast({title:"请登录",icon:"none"}):"success"!=a.result.msg?(t.liked=!t.liked,t.like_count-=t.liked?-1:1,e.index.showToast({title:a.result.message||"操作失败",icon:"none"})):a.result.first&&e.PubSub.publish("update_activity",5)}catch(a){console.error("点赞失败:",a),e.index.showToast({title:"网络错误",icon:"none"})}}else e.index.showToast({title:"请登录",icon:"none"})},toggleComments(e){this.filteredPosts.forEach((t=>{t._id===e._id?t.showComments=!t.showComments:t.showComments=!1})),e.comments||this.fetchComments(e)},async fetchComments(t){try{const s=await e.tr.callFunction({name:"get_comments",data:{post_id:t._id}});if("success"==s.result.msg&&(t.comments=s.result.data,t.comment_count=t.comments.length,this.user.account_id)){const s=e.tr.database(),o=(await s.collection("user-liked").where({account_id:this.user.account_id,target_id:s.command.in(t.comments.map((e=>e._id))),liked:!0}).get()).result.data.map((e=>e.target_id));let i=[];for(const e of t.comments)e.liked=o.includes(e._id),i=i.concat(e.replies);if(i.length>0){const e=(await s.collection("user-liked").where({account_id:this.user.account_id,target_id:s.command.in(i.map((e=>e._id))),liked:!0}).get()).result.data.map((e=>e.target_id));t.comments.forEach((t=>{t.replies.forEach((t=>{t.liked=e.includes(t._id)}))}))}}}catch(s){console.error("获取评论失败:",s)}},async submitComment(t,s,o,i,n){if(!this.newComment.trim()&&0==i||!this.newReply.trim()&&1==i||!this.newReplyReply.trim()&&2==i)e.index.showToast({title:"评论不能为空",icon:"none"});else if(this.user.account_id){e.index.showToast({title:"评论中...",icon:"loading"}),await this.getUserLocation(),await this.resolve_ip();try{const a=await e.tr.callFunction({name:"submit_comment",data:{user:this.user,post:t,comment:s,reply:o,type:i,content:n}});"success"==a.result.msg&&(0==i?(t.comment_count+=1,t.comments.unshift(a.result.data),this.newComment=""):(s.replies.unshift(a.result.data),o?(this.newReplyReply="",o.showReplyInput=!1):(this.newReply="",s.showReplyInput=!1),loading=!1),e.index.hideToast(),e.index.showToast({title:"评论成功",icon:"success"}),e.PubSub.publish("update_activity",10))}catch(a){e.index.showToast({title:"评论失败",icon:"none"})}finally{e.index.hideToast()}}else e.index.showToast({title:"请登录",icon:"none"})},async getUserLocation(){try{const t=await e.tr.callFunction({name:"get_ip",data:{}});200===t.result.code&&(this.user.ip=t.result.data)}catch(t){console.error("获取位置失败",t)}},async resolve_ip(){const t=`https://ipcity.market.alicloudapi.com/ip/city/query?${`ip=${encodeURIComponent(this.user.ip)}&coordsys=WGS84`}`;try{const s=await e.index.request({url:t,method:"GET",header:{Authorization:"APPCODE 1dc84a4fe7fc40238d1a17ad665c59d3"}});if(200===s.statusCode&&200==s.data.code){let e;s.data.data.result.city?e=s.data.data.result.city:s.data.data.result.prov?e=s.data.data.result.province:s.data.data.result.country?e=s.data.data.result.country:s.data.data.result.continuent&&(e=s.data.data.result.continent),(e.endsWith("市")||e.endsWith("省"))&&(e=e.slice(0,-1)),this.user.ip=e,console.log("获取到的IP地址",this.user.ip)}}catch(s){console.error("resolve_ip 请求失败:",s)}},handleLongPressComment_Reply(t,s,o,i,n){n.account_id&&n.account_id!==this.user.account_id&&!this.user.admin||e.index.showActionSheet({itemList:["删除"],success:a=>{0===a.tapIndex&&e.index.showModal({title:"确认删除",content:"确定要删除这条评论吗？",success:e=>{e.confirm&&this.deleteComment_Reply(t,s,o,i,n)}})}})},async deleteComment_Reply(t,s,o,i,n){e.index.showToast({title:"删除中...",icon:"loading"});try{const o=await e.tr.callFunction({name:"delete_comment_reply",data:{parent:i,item:n}});200===o.result.code&&(e.index.hideToast(),e.index.showToast({title:"删除成功",icon:"success"}),"post_id"in n?(this.posts[t].comments.splice(s,1),this.posts[t].comment_count-=1):(console.log("replies",o.result.data.replies),this.$set(this.posts[t].comments[s],"replies",o.result.data.replies)))}catch(a){console.error("删除失败:",a),e.index.showToast({title:"网络错误",icon:"none"})}finally{e.index.hideToast()}},to_source_post(t){e.index.navigateTo({url:`/pages/source_post/source_post?post_id=${t.source_post.post_id}&account_id=${this.user.account_id}&admin=${this.user.admin}&username=${this.user.username}&avatar=${this.user.avatar}`})},to_personal_info(t){e.index.navigateTo({url:`/pages/personal_info/personal_info?account_id=${t.account_id}&visitor_account_id=${this.user.account_id}&visitor_admin=${this.user.admin}`})},formatDate(e){const t=e=>e.toString().padStart(2,"0");return`${(e=new Date(e)).getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())} ${t(e.getHours())}:${t(e.getMinutes())}`},toggleReplyInput(e){this.$set(e,"showReplyInput",!e.showReplyInput),this.last_showInput&&this.last_showInput!==e&&(this.last_showInput.showReplyInput=!1),this.last_showInput=e},async login_register(t,s,o,i,n){const a=await e.tr.callFunction({name:"login_register",data:{action:t,account_id:s,username:o,password:i,has_token:n}});if(200===a.result.code){e.index.showToast({title:"已登录",icon:"success"});const t=getApp();t.userInfo=a.result.userInfo,t.login_status=!0,Object.keys(a.result.userInfo).forEach((e=>{this.user[e]=a.result.userInfo[e]})),this.user.unread_messages&&e.index.showTabBarRedDot({index:1}),e.index.setStorageSync("uid",a.result.userInfo.account_id)}else this.posts=[],this.fetchPosts(null,!1),e.index.removeStorageSync("uid")}}};const o=e._export_sfc(s,[["render",function(s,o,i,n,a,r){return e.e({a:a.show_top_bar},a.show_top_bar?{b:t._imports_0,c:e.o([e=>a.searchQuery=e.detail.value,e=>r.filterPosts()]),d:a.searchQuery,e:t._imports_1,f:e.o((e=>r.to_post(null,0))),g:e.n({"no-shadow":a.isAtTop})}:{},{h:e.f(a.filteredPosts,((s,o,i)=>e.e({a:s.avatar,b:e.o((e=>r.to_personal_info(s)),s._id),c:e.t(s.username),d:e.t(r.formatDate(s.create_time)),e:e.t(s.ip),f:s.account_id==a.user.account_id||a.user.admin},s.account_id==a.user.account_id||a.user.admin?{g:t._imports_2,h:e.o((()=>r.confirmDeletePost(s)),s._id)}:{},{i:0==s.post_type},0==s.post_type?e.e({j:e.t(s.content),k:s.media.length>1},s.media.length>1?e.e({l:Array.isArray(s.media)&&s.media.length},Array.isArray(s.media)&&s.media.length?{m:e.f(s.media,((t,o,i)=>e.e({a:"image"===t.type},"image"===t.type?{b:t.url}:"video"===t.type?{d:t.url}:{},{c:"video"===t.type,e:o,f:e.o((()=>r.previewMedia(s.media,o)),o)}))),n:e.n("media-count-"+s.media.length)}:{}):1==s.media.length?e.e({p:"image"===s.media[0].type},"image"===s.media[0].type?{q:s.media[0].url}:"video"===s.media[0].type?{s:s.media[0].url}:{},{r:"video"===s.media[0].type,t:e.o((()=>r.previewMedia(s.media,0)),s._id)}):{},{o:1==s.media.length}):e.e({v:e.t(s.content),w:s.source_post.avatar},s.source_post.avatar?{x:s.source_post.avatar}:{},{y:s.source_post.username},s.source_post.username?{z:e.t(s.source_post.username)}:{},{A:s.source_post.create_time},s.source_post.create_time?{B:e.t(r.formatDate(s.source_post.create_time)),C:e.t(s.source_post.ip)}:{},{D:s.source_post.content},s.source_post.content?{E:e.t(s.source_post.content)}:{},{F:s.source_post.media},s.source_post.media?e.e({G:s.source_post.media.length>1},s.source_post.media.length>1?e.e({H:Array.isArray(s.source_post.media)&&s.source_post.media.length},Array.isArray(s.source_post.media)&&s.source_post.media.length?{I:e.f(s.source_post.media,((t,o,i)=>e.e({a:"image"===t.type},"image"===t.type?{b:t.url}:"video"===t.type?{d:t.url}:{},{c:"video"===t.type,e:o,f:e.o((()=>r.previewMedia(s.source_post.media,o)),o)}))),J:e.n("media-count-"+s.source_post.media.length)}:{}):1==s.source_post.media.length?e.e({L:"image"===s.source_post.media[0].type},"image"===s.source_post.media[0].type?{M:s.source_post.media[0].url}:"video"===s.source_post.media[0].type?{O:s.source_post.media[0].url}:{},{N:"video"===s.source_post.media[0].type,P:e.o((()=>r.previewMedia(s.source_post.media,0)),s._id)}):{},{K:1==s.source_post.media.length}):{},{Q:e.o((e=>r.to_source_post(s)),s._id)}),{R:e.t(s.device_model),S:"仅我可见"==s.visibility},(s.visibility,{}),{T:s.liked?"/static/index/已赞.png":"/static/index/赞.png",U:s.liked?1:"",V:e.t(s.like_count),W:e.o((()=>r.like(s,s,null,null,0)),s._id),X:e.t(s.comment_count||0),Y:e.o((()=>r.toggleComments(s)),s._id),Z:e.t(s.forward_count||0),aa:e.o((()=>r.to_post(s,1)),s._id),ab:s.showComments},s.showComments?{ac:e.f(s.comments,((t,i,n)=>e.e({a:t.avatar,b:e.o((e=>r.to_personal_info(t)),t._id),c:e.t(t.username),d:e.t(r.formatDate(t.create_time)),e:e.t(t.ip),f:t.liked?"/static/index/已赞.png":"/static/index/赞.png",g:e.t(t.like_count),h:e.o((()=>r.like(t,s,t,null,1)),t._id),i:e.t(t.content),j:e.o((()=>r.toggleReplyInput(t)),t._id),k:t.showReplyInput},t.showReplyInput?{l:"回复"+t.username+"...",m:a.newReply,n:e.o((e=>a.newReply=e.detail.value),t._id),o:e.o((()=>r.submitComment(s,t,null,1,a.newReply)),t._id)}:{},{p:t.replies.length&&!t.showReply},t.replies.length&&!t.showReply?{q:e.t(t.replies.length),r:e.o((e=>t.showReply=!0),t._id)}:{},{s:t.showReply},t.showReply?{t:e.f(t.replies,((n,c,l)=>e.e({a:n.avatar,b:e.o((e=>r.to_personal_info(n)),n._id),c:e.t(n.username),d:e.t(r.formatDate(n.create_time)),e:e.t(n.ip),f:n.liked?"/static/index/已赞.png":"/static/index/赞.png",g:e.t(n.like_count),h:e.o((()=>r.like(n,s,t,n,2)),n._id),i:n.reply_username},n.reply_username?{j:e.t(n.reply_username)}:{},{k:e.t(n.content),l:e.o((()=>r.toggleReplyInput(n)),n._id),m:n.showReplyInput},n.showReplyInput?{n:"回复"+n.username+"...",o:a.newReplyReply,p:e.o((e=>a.newReplyReply=e.detail.value),n._id),q:e.o((()=>r.submitComment(s,t,n,2,a.newReplyReply)),n._id)}:{},{r:n._id,s:e.o((e=>r.handleLongPressComment_Reply(o,i,c,t,n)),n._id)})))}:{},{v:t._id,w:e.o((e=>r.handleLongPressComment_Reply(o,i,null,s,t)),t._id)}))),ad:a.newComment,ae:e.o((e=>a.newComment=e.detail.value),s._id),af:e.o((()=>r.submitComment(s,null,null,0,a.newComment)),s._id),ag:e.o((()=>{}),s._id)}:{},{ah:s._id}))),i:t._imports_3,j:t._imports_4,k:a.loading&&!a.loaded},(a.loading&&a.loaded,{}),{l:a.loaded&&!a.loading},(a.loaded&&a.loading,{}))}],["__scopeId","data-v-bd64b687"]]);s.__runtimeHooks=1,wx.createPage(o);
