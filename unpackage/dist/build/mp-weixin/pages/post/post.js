"use strict";const e=require("../../common/vendor.js"),t=require("../../common/assets.js"),s={data:()=>({content:"",mediaFiles:[],type:0,source_post:{},permissionText:"所有人可见",permissionOptions:["所有人可见","仅我可见"],user:{account_id:null,username:"未登录",avatar:"",ip:"未知"},subtoken:null,loading:!1}),watch:{loading(t,s){1==t&&e.index.showLoading({title:"正在发布..."})}},onLoad(){this.subtoken=e.PubSub.subscribe("to_post",((e,t)=>{this.user.account_id=t.account_id,this.user.username=t.username,this.user.avatar=t.avatar,this.type=t.type,t.share_post&&(this.source_post=t.share_post),console.log("to_post",this.source_post,this.user)}))},onUnload(){this.subtoken&&(e.PubSub.unsubscribe(this.subtoken),this.subtoken=null)},methods:{showMediaPicker(){e.index.showActionSheet({itemList:["照片","视频"],success:e=>{0===e.tapIndex?this.chooseImage():1===e.tapIndex&&this.chooseVideo()}})},chooseImage(){e.index.chooseImage({count:9-this.mediaFiles.length,sourceType:["album","camera"],success:e=>{e.tempFilePaths.forEach((e=>{this.mediaFiles.push({url:e,type:"image"})}))}})},chooseVideo(){e.index.chooseVideo({count:9-this.mediaFiles.length,sourceType:["album","camera"],duration:30,success:t=>{this.mediaFiles.length<9?this.mediaFiles.push({url:t.tempFilePath,type:"video"}):e.index.showToast({title:"最多只能上传9个媒体文件",icon:"none"})}})},previewMedia(t,s){e.index.previewMedia({sources:t.map((e=>({url:e.url,type:e.type}))),current:s})},removeMedia(e){this.mediaFiles.splice(e,1)},onPermissionChange(e){this.permissionText=this.permissionOptions[e.detail.value]},async getUserLocation(){try{const t=await e.tr.callFunction({name:"get_ip",data:{}});200===t.result.code&&(this.user.ip=t.result.data)}catch(t){console.error("获取位置失败",t)}},async resolve_ip(){const t=`https://ipcity.market.alicloudapi.com/ip/city/query?${`ip=${encodeURIComponent(this.user.ip)}&coordsys=WGS84`}`;try{const s=await e.index.request({url:t,method:"GET",header:{Authorization:"APPCODE 1dc84a4fe7fc40238d1a17ad665c59d3"}});if(200===s.statusCode&&200==s.data.code){let e;s.data.data.result.city?e=s.data.data.result.city:s.data.data.result.prov?e=s.data.data.result.province:s.data.data.result.country?e=s.data.data.result.country:s.data.data.result.continuent&&(e=s.data.data.result.continent),(e.endsWith("市")||e.endsWith("省"))&&(e=e.slice(0,-1)),this.user.ip=e,console.log("获取到的IP地址",this.user.ip)}}catch(s){console.error("resolve_ip 请求失败:",s)}},async submitPost(){if(!this.loading)if(this.user.account_id)if(this.content.trim()||0!==this.mediaFiles.length){this.loading=!0,this.mediaFiles.length&&(this.mediaFiles=await Promise.all(this.mediaFiles.map((async t=>{try{const s=t.url.split(".").pop().toLowerCase(),i=`Post/${this.user.account_id}-${this.user.username}-${Date.now()}-${Math.floor(1e4*Math.random())}.${s}`;return{url:(await e.tr.uploadFile({filePath:t.url,cloudPath:i,fileType:t.type,cloudPathAsRealPath:!0,onUploadProgress:t=>{var s=Math.round(100*t.loaded)/t.total;e.index.showLoading({title:`上传中...${s}%`})},header:{"Cache-Control":"max-age=2592000"}})).fileID,type:t.type}}catch(s){return console.error("文件上传失败",t.url,s),null}}))),this.mediaFiles=this.mediaFiles.filter((e=>null!==e))),await this.getUserLocation(),await this.resolve_ip();try{const t=await e.tr.callFunction({name:"post",data:{user:this.user,content:this.content,media:this.mediaFiles,post_type:this.type,temp_source_post:this.source_post,visibility:this.permissionText,create_time:(new Date).toISOString(),ip:this.user.ip,tags:[],status:1}});200===t.result.code?(e.index.showToast({title:"发布成功",icon:"success"}),e.PubSub.publish("return_index",t.result.data),setTimeout((()=>{e.index.navigateBack(),this.loading=!1}),500)):401===t.result.code?(e.index.showToast({title:"请登录",icon:"none"}),this.loading=!1):(e.index.showToast({title:"发布失败",icon:"none"}),this.loading=!1,console.log("发布失败",t.result))}catch(t){console.error("发布失败",t),e.index.showToast({title:"发布失败",icon:"none"}),this.loading=!1}}else e.index.showToast({title:"内容不能为空",icon:"none"});else e.index.showToast({title:"请登录",icon:"none"})},formatDate(e){const t=e=>e.toString().padStart(2,"0");return`${(e=new Date(e)).getFullYear()}-${t(e.getMonth()+1)}-${t(e.getDate())} ${t(e.getHours())}:${t(e.getMinutes())}`}}};const i=e._export_sfc(s,[["render",function(s,i,o,a,n,r){return e.e({a:e.o((e=>r.submitPost())),b:n.content,c:e.o((e=>n.content=e.detail.value)),d:0===n.type},0===n.type?e.e({e:e.f(n.mediaFiles,((t,s,i)=>e.e({a:"image"===t.type},"image"===t.type?{b:t.url}:"video"===t.type?{d:t.url}:{},{c:"video"===t.type,e:e.o((()=>r.removeMedia(s)),s),f:s,g:e.o((()=>r.previewMedia(n.mediaFiles,s)),s)}))),f:n.mediaFiles.length<9},n.mediaFiles.length<9?{g:t._imports_0$1,h:e.o(((...e)=>r.showMediaPicker&&r.showMediaPicker(...e)))}:{}):e.e({i:n.source_post.avatar,j:e.t(n.source_post.username),k:e.t(r.formatDate(n.source_post.create_time)),l:e.t(n.source_post.ip),m:e.t(n.source_post.content),n:Array.isArray(n.source_post.media)&&n.source_post.media.length},Array.isArray(n.source_post.media)&&n.source_post.media.length?{o:e.f(n.source_post.media,((t,s,i)=>e.e({a:"image"===t.type},"image"===t.type?{b:t.url}:"video"===t.type?{d:t.url}:{},{c:"video"===t.type,e:s,f:e.o((()=>r.previewMedia(n.source_post.media,s)),s)}))),p:e.n("media-count-"+n.source_post.media.length)}:{}),{q:e.t(n.permissionText),r:n.permissionOptions,s:e.o(((...e)=>r.onPermissionChange&&r.onPermissionChange(...e)))})}],["__scopeId","data-v-97d8b894"]]);wx.createPage(i);
